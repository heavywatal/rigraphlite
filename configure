#!/bin/sh
echo "PWD: $PWD"
echo "R_PACKAGE_DIR: $R_PACKAGE_DIR"
echo "IGRAPH_INSTALL_PREFIX: ${IGRAPH_INSTALL_PREFIX:=${R_PACKAGE_DIR}}"
IGRAPH_VERSION_H="${IGRAPH_INSTALL_PREFIX}/include/igraph/igraph_version.h"
if [ -e "$IGRAPH_VERSION_H" ]; then
  echo "Using preinstalled C igraph in $IGRAPH_INSTALL_PREFIX"
  grep "IGRAPH_VERSION " $IGRAPH_VERSION_H
else
  autoconf --version || brew install autoconf
  automake --version || brew install automake
  libtoolize  --version || glibtoolize  --version || brew install libtool
  if ! autoconf --version >/dev/null || ! automake --version >/dev/null; then
    echo 'Please install "autoconf", "automake", and "libtool" to build this package.'
    echo 'The easiest way is to use Homebrew (https://brew.sh/):'
    echo '  brew install autoconf automake libtool'
    echo 'Otherwise, follow the official instruction:'
    echo '  https://www.gnu.org/software/autoconf/'
    echo '  https://www.gnu.org/software/automake/'
    echo '  https://www.gnu.org/software/libtool/'
    exit 1
  fi
  echo "IGRAPH_SOURCE: ${IGRAPH_SOURCE:=${R_SESSION_TMPDIR}/../${R_PACKAGE_NAME}/igraph}"
  if [ -e "$IGRAPH_SOURCE" ]; then
    git -C $IGRAPH_SOURCE pull --ff-only
  else
    IGRAPH_REMOTE="https://github.com/heavywatal/igraph.git"
    git clone --depth=1 --single-branch $IGRAPH_REMOTE $IGRAPH_SOURCE
  fi
  cd $IGRAPH_SOURCE
  ./bootstrap.sh
  CONFIG_OPTIONS="--disable-static --with-external-blas --with-external-lapack"
  ./configure --prefix=$IGRAPH_INSTALL_PREFIX $CONFIG_OPTIONS >/dev/null
  make ${MAKEFLAGS:=-j2} install 2>/dev/null
  cd $OLDPWD
fi

CPPFLAGS="-I${IGRAPH_INSTALL_PREFIX}/include"
LIBDIR="${IGRAPH_INSTALL_PREFIX}/lib"
LDFLAGS="-L${LIBDIR} -Wl,-rpath,${LIBDIR}"
LDLIBS="-ligraph"

sed "
s|@CPPFLAGS@|$CPPFLAGS|
s|@LDFLAGS@|$LDFLAGS|
s|@LDLIBS@|$LDLIBS|
" src/Makevars.in > ${R_SESSION_TMPDIR}/Makevars

cmp ${R_SESSION_TMPDIR}/Makevars src/Makevars 2>/dev/null ||\
 mv ${R_SESSION_TMPDIR}/Makevars src/Makevars
cat src/Makevars
