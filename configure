#!/bin/sh
PATH="$PATH:/Applications/CMake.app/Contents/bin"
cmake --version || brew install cmake
if ! cmake --version >/dev/null; then
  echo 'Please install CMake to build this package.'
  echo 'The easiest way is to use Homebrew (https://brew.sh/):'
  echo '  brew install cmake'
  echo 'Otherwise, use an installer available at https://cmake.org/download/'
  exit 1
fi
unset LDFLAGS
echo "CC CFLAGS: $CC $CFLAGS"
echo "CXX CXXFLAGS: $CXX $CXXFLAGS"
echo "PWD: $PWD"
echo "R_LIBRARY_DIR: $R_LIBRARY_DIR"
echo "R_PACKAGE_DIR: $R_PACKAGE_DIR"
BUILD_DIR="${R_SESSION_TMPDIR}/${R_PACKAGE_NAME}-build"
if [ -n "$DEVTOOLS_LOAD" ] && [ ! -f "build/compile_commands.json" ]; then
  BUILD_DIR="build"
fi
echo "BUILD_DIR: $BUILD_DIR"
rm -r "${BUILD_DIR}"/CMake*
cmake -S src -B "$BUILD_DIR" -DCMAKE_INSTALL_PREFIX="${BUILD_DIR}/CMakeInstallPrefix"
cmake --build "$BUILD_DIR" -j3
cmake --install "$BUILD_DIR"
