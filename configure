#!/bin/sh
echo "CXX: ${CXX:=$(${R_HOME}/bin/R CMD config CXX)}"
echo "R_PACKAGE_DIR: $R_PACKAGE_DIR"
echo "IGRAPH_INSTALL_PREFIX: ${IGRAPH_INSTALL_PREFIX:=${R_PACKAGE_DIR}}"
PKG_CPPFLAGS="-DSTRICT_R_HEADERS -I${IGRAPH_INSTALL_PREFIX}/include"
LIBDIR="${IGRAPH_INSTALL_PREFIX}/lib"
LDFLAGS="-L${LIBDIR} -Wl,-rpath,${LIBDIR}"
LDLIBS="-ligraph"
PKG_LIBS="$LDFLAGS $LDLIBS"

if [ -e "${IGRAPH_INSTALL_PREFIX}/include/igraph/igraph.h" ]; then
  echo "Using preinstalled igraph: ${IGRAPH_INSTALL_PREFIX}"
else
  if [ -e ".git" ]; then
    # source repo
    IGRAPH_SOURCE="src/igraph"
  else
    # bundled package
    BUILD_DIR="${R_SESSION_TMPDIR}/../igraphlite"
    IGRAPH_SOURCE="${BUILD_DIR}/igraph"
  fi
  echo "IGRAPH_SOURCE: ${IGRAPH_SOURCE}"
  if [ -e "$IGRAPH_SOURCE" ]; then
    git -C $IGRAPH_SOURCE pull --ff-only
  else
    IGRAPH_REMOTE="https://github.com/heavywatal/igraph.git"
    git clone --depth=1 --single-branch $IGRAPH_REMOTE $IGRAPH_SOURCE
  fi
  cd $IGRAPH_SOURCE
  ./bootstrap.sh
  ./configure --prefix=$IGRAPH_INSTALL_PREFIX --disable-static --with-external-blas --with-external-lapack
  make -j2 install-exec
  cd ..
fi

cat <<EOS >src/Makevars
CXX_STD = CXX14
PKG_CPPFLAGS = $PKG_CPPFLAGS
PKG_LIBS = $PKG_LIBS
EOS
