#!/bin/sh
echo "PWD: $PWD"
echo "R_PACKAGE_DIR: $R_PACKAGE_DIR"
CMAKE_PREFIX_PATH=${R_PACKAGE_DIR}
echo "IGRAPH_INSTALL_PREFIX: ${IGRAPH_INSTALL_PREFIX}"
if [ -e "$IGRAPH_INSTALL_PREFIX" ]; then
  CMAKE_PREFIX_PATH="${IGRAPH_INSTALL_PREFIX};${CMAKE_PREFIX_PATH}"
fi
if [ -z "$CXX" ]; then
  CXX=$(${R_HOME}/bin/R CMD config CXX14)
  CXX=${CXX% *}
fi
echo "CXX: $CXX"
cmake --version || brew install cmake
if ! cmake --version >/dev/null; then
  echo 'Please install CMake to build this package.'
  echo 'The easiest way is to use Homebrew (https://brew.sh/):'
  echo '  brew install cmake'
  echo 'Otherwise, use an installer available at https://cmake.org/download/'
  exit 1
fi
BUILD_DIR="${R_SESSION_TMPDIR}/${R_PACKAGE_NAME}-build"
echo "BUILD_DIR: $BUILD_DIR"
rm -r "${BUILD_DIR}/CMake*"
cmake -Hsrc -B$BUILD_DIR -DCMAKE_CXX_COMPILER="$CXX" -DCMAKE_INSTALL_PREFIX="$R_PACKAGE_DIR" -DCMAKE_PREFIX_PATH="$CMAKE_PREFIX_PATH" -DFETCHCONTENT_SOURCE_DIR_IGRAPH="$FETCHCONTENT_SOURCE_DIR_IGRAPH"
cmake --build $BUILD_DIR -- -j2
cmake --build $BUILD_DIR --target install
